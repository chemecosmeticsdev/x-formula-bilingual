version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - echo "Installing dependencies..."
            - npm ci
            - echo "Validating environment variables..."
            - echo "NODE_ENV=$NODE_ENV"
            - echo "LAMBDA_BEDROCK_ENDPOINT=$LAMBDA_BEDROCK_ENDPOINT"
        build:
          commands:
            - echo "Building Next.js application..."
            - npm run build
            - echo "Build completed successfully!"
        postBuild:
          commands:
            - echo "Running post-build optimizations..."
            - echo "Analyzing bundle size..."
            - npx --yes next-bundle-analyzer || echo "Bundle analysis optional"
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
env:
  variables:
    # Build-time variables
    NODE_ENV: production
    NEXT_PUBLIC_APP_NAME: "X Formula Platform"
    NEXT_PUBLIC_APP_VERSION: "2.0.0"
    NEXT_PUBLIC_FORCE_HTTPS: "true"
    NEXT_PUBLIC_SECURITY_HEADERS: "true"
    NEXT_PUBLIC_CDN_ENABLED: "true"
    NEXT_PUBLIC_IMAGE_OPTIMIZATION: "true"
    NEXT_PUBLIC_ANALYTICS_ENABLED: "true"
    BUILD_STANDALONE: "true"
    OUTPUT_FILE_TRACING: "true"
    EXPERIMENTAL_APP_DIR: "true"
  # Runtime environment variables (set in Amplify Console)
  # LAMBDA_BEDROCK_ENDPOINT: Set in Amplify Console Environment Variables
  # LAMBDA_BEDROCK_IMAGE_ENDPOINT: Set in Amplify Console Environment Variables
  # BEDROCK_ACCESS_KEY_ID: Set in Amplify Console Environment Variables
  # BEDROCK_SECRET_ACCESS_KEY: Set in Amplify Console Environment Variables
  # BEDROCK_REGION: Set in Amplify Console Environment Variables